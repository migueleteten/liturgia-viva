<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crear Canción</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        .line-type-n { color: red; font-style: italic; font-weight: normal; }
        .line-type-e { color: blue; font-style: italic; }
        .line-part-p, .line-part-p1, .line-part-p2 { font-style: italic; }
        .line-part-e { font-weight: bold; }
        .line-type-t { font-weight: bold; text-decoration: underline;}
        .table-hover tbody tr:hover .action-buttons { visibility: visible; }
        .action-buttons { visibility: hidden; position: relative; }
        .action-buttons { display: inline-block; width: 100%; text-align: right; }
        tr:hover .action-buttons { visibility: visible; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Crear Canción</h1>
        <form id="songForm">
            <div class="form-group">
                <label for="songText">Texto de la Canción</label>
                <textarea class="form-control" id="songText" rows="10"></textarea>
            </div>
            <button type="button" id="convertSongBtn" class="btn btn-primary">Convertir Canción</button>
        </form>
        <h2 id="songTitle"></h2>
        <div class="mb-2">
            <button id="undoBtn" class="btn btn-secondary" disabled><i class="fas fa-reply"></i> Deshacer</button>
            <button id="redoBtn" class="btn btn-secondary" disabled><i class="fas fa-share"></i> Rehacer</button>
        </div>
        <table id="songTable" class="table table-sm w-auto table-hover">
            <thead>
                <tr>
                    <th>Tipo de Línea</th>
                    <th>Parte de la Canción</th>
                    <th>Contenido</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
        <button id="saveSongBtn" class="btn btn-success">Guardar Canción</button>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.1/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script>
        $(document).ready(function() {
            const lineTypes = ['t', 'n', 'l', 'e', 'x', 'c'];
            const songParts = ['f1', 'f2', 'f3', 'f4', 'p1', 'p2', 'p', 'e'];

            let undoStack = [];
            let redoStack = [];

            function createSelectOptions(options, selectedValue) {
                return options.map(option => `<option value="${option}" ${option === selectedValue ? 'selected' : ''}>${option}</option>`).join('');
            }

            function updateRowStyles(row) {
                const lineType = row.find('.line-type-select').val();
                const songPart = row.find('.song-part-select').val();
                const contentCell = row.find('.line-content');

                contentCell.removeClass().addClass('line-content');
                if (lineType === 'n') {
                    contentCell.addClass('line-type-n');
                } else if (lineType === 'e') {
                    contentCell.addClass('line-type-e');
                }

                if (['p', 'p1', 'p2'].includes(songPart)) {
                    contentCell.addClass('line-part-p');
                } else if (songPart === 'e') {
                    contentCell.addClass('line-part-e');
                }

                if (lineType === 'n' && songPart === 'e') {
                    contentCell.removeClass('line-part-e');
                }

                if (lineType === 't') {
                    contentCell.addClass('line-type-t');
                }
            }

            function addRowAfter(index) {
                const currentData = captureTableData();
                const newRow = {
                    tipo_linea: 'x',
                    parte_cancion: 'f1',
                    contenido: ''
                };
                const estructura = $('#songTable tbody').data('estructura') || [];
                currentData.splice(index + 1, 0, newRow);
                undoStack.push({ action: 'add', index: index + 1 });
                redoStack = [];
                renderTable(currentData);
            }

            function deleteRow(index) {
                const estructura = $('#songTable tbody').data('estructura') || [];
                const currentData = captureTableData();
                const deletedRow = currentData.splice(index, 1)[0];
                undoStack.push({ action: 'delete', index, row: deletedRow });
                redoStack = [];
                renderTable(currentData);
            }

            function captureTableData() {
                const estructura = [];
                $('#songTable tbody tr').each(function() {
                    const row = $(this);
                    const tipo_linea = row.find('.line-type-select').val();
                    const parte_cancion = row.find('.song-part-select').val();
                    const contenido = row.find('.line-content').text();
                    estructura.push({ tipo_linea, parte_cancion, contenido });
                });
                return estructura;
            }

            function undo() {
                if (undoStack.length === 0) return;
                const lastAction = undoStack.pop();
                const estructura = $('#songTable tbody').data('estructura') || [];

                if (lastAction.action === 'add') {
                    redoStack.push({ action: 'add', index: lastAction.index });
                    estructura.splice(lastAction.index, 1);
                } else if (lastAction.action === 'delete') {
                    redoStack.push({ action: 'delete', index: lastAction.index, row: lastAction.row });
                    estructura.splice(lastAction.index, 0, lastAction.row);
                }

                renderTable(estructura);
            }

            function redo() {
                if (redoStack.length === 0) return;
                const lastAction = redoStack.pop();
                const estructura = $('#songTable tbody').data('estructura') || [];

                if (lastAction.action === 'add') {
                    undoStack.push({ action: 'add', index: lastAction.index });
                    estructura.splice(lastAction.index, 0, { tipo_linea: 'x', parte_cancion: 'f1', contenido: '' });
                } else if (lastAction.action === 'delete') {
                    undoStack.push({ action: 'delete', index: lastAction.index, row: lastAction.row });
                    estructura.splice(lastAction.index, 1);
                }

                renderTable(estructura);
            }

            function renderTable(estructura) {
                $('#songTable tbody').empty().data('estructura', estructura);
                estructura.forEach((linea, index) => {
                    const row = $('<tr>');
                    const tipoLineaCell = $('<td>').html(`<select class="form-control form-control-sm line-type-select">${createSelectOptions(lineTypes, linea.tipo_linea)}</select>`).appendTo(row);
                    const parteCancionCell = $('<td>').html(`<select class="form-control form-control-sm song-part-select">${createSelectOptions(songParts, linea.parte_cancion)}</select>`).appendTo(row);
                    const contenidoCell = $('<td>').attr('contenteditable', 'true').addClass('line-content').text(linea.contenido).css('white-space', 'pre').appendTo(row);

                    const actionButtons = $('<td>').addClass('action-buttons').appendTo(row);
                    $('<button>').addClass('btn btn-sm').html('<i class="fas fa-trash"></i>').on('click', () => deleteRow(index)).appendTo(actionButtons);
                    $('<button>').addClass('btn btn-sm').html('<i class="fas fa-plus"></i>').on('click', () => addRowAfter(index)).appendTo(actionButtons);

                    updateRowStyles(row);

                    $('#songTable tbody').append(row);
                });

                $('#songTable').on('change', 'select', function() {
                    const row = $(this).closest('tr');
                    updateRowStyles(row);
                });

                $('#undoBtn').prop('disabled', undoStack.length === 0);
                $('#redoBtn').prop('disabled', redoStack.length === 0);
            }

            $('#convertSongBtn').on('click', function() {
                const songText = $('#songText').val();
                if (songText.trim() === '') {
                    alert('Por favor, ingresa el texto de la canción.');
                    return;
                }

                $.ajax({
                    url: '/api/songs/convert',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ texto: songText }),
                    success: function(response) {
                        const estructura = response.estructura;

                        $('#songTitle').text('Título Detectado: ' + (estructura.find(line => line.tipo_linea === 't')?.contenido || 'Sin Título'));
                        undoStack = [];
                        redoStack = [];
                        renderTable(estructura);
                    },
                    error: function() {
                        alert('Error al convertir la canción. Por favor, intenta de nuevo.');
                    }
                });
            });

            $('#undoBtn').on('click', undo);
            $('#redoBtn').on('click', redo);

        });
    </script>
</body>
</html>
